C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE PROTOCOL
OBJECT MODULE PLACED IN .\Objects\protocol.obj
COMPILER INVOKED BY: d:\cccc2020\TOOL\Keil\C51\BIN\C51.EXE ..\User\protocol.c COMPACT BROWSE DEBUG OBJECTEXTEND PRINT(.\
                    -Listings\protocol.lst) TABS(2) OBJECT(.\Objects\protocol.obj)

line level    source

   1          /****************************************Copyright (c)*************************
   2          **                               ç‰ˆæƒæ‰€æœ‰ (C), 2015-2017, æ¶‚é¸¦ç§‘æŠ€
   3          **
   4          **                                 http://www.tuya.com
   5          **
   6          **--------------æ–‡ä»¶ä¿¡æ¯-------------------------------------------------------
   7          **æ–‡   ä»¶   å: protocol.c
   8          **æ        è¿°: ä¸‹å‘/ä¸ŠæŠ¥æ•°æ®å¤„ç†å‡½æ•°
   9          **ä½¿ ç”¨ è¯´ æ˜ :
  10          
  11                            *******éå¸¸é‡è¦ï¼Œä¸€å®šè¦çœ‹å“¦ï¼ï¼ï¼********
  12          
  13          ** 1ã€ç”¨æˆ·åœ¨æ­¤æ–‡ä»¶ä¸­å®ç°æ•°æ®ä¸‹å‘/ä¸ŠæŠ¥åŠŸèƒ½
  14          ** 2ã€DPçš„ID/TYPEåŠæ•°æ®å¤„ç†å‡½æ•°éƒ½éœ€è¦ç”¨æˆ·æŒ‰ç…§å®é™…å®šä¹‰å®ç°
  15          ** 3ã€å½“å¼€å§‹æŸäº›å®å®šä¹‰åéœ€è¦ç”¨æˆ·å®ç°ä»£ç çš„å‡½æ•°å†…éƒ¨æœ‰#erræç¤º,å®Œæˆå‡½æ•°åè¯·å
             -ˆ é™¤è¯¥#err
  16          **
  17          **--------------å½“å‰ç‰ˆæœ¬ä¿®è®¢---------------------------------------------------
  18          ** ç‰ˆ  æœ¬: v1.0
  19          ** æ—¥ã€€æœŸ: 2017å¹´5æœˆ3æ—¥
  20          ** æã€€è¿°: 1:åˆ›å»ºæ¶‚é¸¦bluetoothå¯¹æ¥MCU_SDK
  21          **
  22          **-----------------------------------------------------------------------------
  23          ******************************************************************************/
  24          #include "HC89S003F4.h"
  25          #include "HC-MCU-XBR.h"
  26          #include "bluetooth.h"
  27          
  28          /******************************************************************************
  29                                          ç§»æ¤é¡»çŸ¥:
  30          1:MCUå¿…é¡»åœ¨whileä¸­ç›´æ¥è°ƒç”¨mcu_api.cå†…çš„bt_uart_service()å‡½æ•°
  31          2:ç¨‹åºæ­£å¸¸åˆå§‹åŒ–å®Œæˆå,å»ºè®®ä¸è¿›è¡Œå…³ä¸²å£ä¸­æ–­,å¦‚å¿…é¡»å…³ä¸­æ–­,å…³ä¸­æ–­æ—¶é—´å¿…é¡»çŸ
             -­,å…³ä¸­æ–­ä¼šå¼•èµ·ä¸²å£æ•°æ®åŒ…ä¸¢å¤±
  32          3:è¯·å‹¿åœ¨ä¸­æ–­/å®šæ—¶å™¨ä¸­æ–­å†…è°ƒç”¨ä¸ŠæŠ¥å‡½æ•°
  33          ******************************************************************************/
  34          
  35                   
  36          /******************************************************************************
  37                                        ç¬¬ä¸€æ­¥:åˆå§‹åŒ–
  38          1:åœ¨éœ€è¦ä½¿ç”¨åˆ°btç›¸å…³æ–‡ä»¶çš„æ–‡ä»¶ä¸­include "bt.h"
  39          2:åœ¨MCUåˆå§‹åŒ–ä¸­è°ƒç”¨mcu_api.cæ–‡ä»¶ä¸­çš„bt_protocol_init()å‡½æ•°
  40          3:å°†MCUä¸²å£å•å­—èŠ‚å‘é€å‡½æ•°å¡«å…¥protocol.cæ–‡ä»¶ä¸­uart_transmit_outputå‡½æ•°å†…,å¹¶åˆ é™¤#error
  41          4:åœ¨MCUä¸²å£æ¥æ”¶å‡½æ•°ä¸­è°ƒç”¨mcu_api.cæ–‡ä»¶å†…çš„uart_receive_inputå‡½æ•°,å¹¶å°†æ¥æ”¶åˆ°çš„å­—èŠ‚ä
             -½œä¸ºå‚æ•°ä¼ å…¥
  42          5:å•ç‰‡æœºè¿›å…¥whileå¾ªç¯åè°ƒç”¨mcu_api.cæ–‡ä»¶å†…çš„bt_uart_service()å‡½æ•°
  43          ******************************************************************************/
  44          
  45          /******************************************************************************
  46                                  1:dpæ•°æ®ç‚¹åºåˆ—ç±»å‹å¯¹ç…§è¡¨
  47                    **æ­¤ä¸ºè‡ªåŠ¨ç”Ÿæˆä»£ç ,å¦‚åœ¨å¼€å‘å¹³å°æœ‰ç›¸å…³ä¿®æ”¹è¯·é‡æ–°ä¸‹è½½MCU_SDK**         
  48          ******************************************************************************/
  49          const DOWNLOAD_CMD_S download_cmd[] =
  50          {
  51            {DPID_SWITCH_LED, DP_TYPE_BOOL},
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 2   

  52            {DPID_BRIGHT_VALUE, DP_TYPE_VALUE},
  53            {DPID_LIGHT_PARAMETER, DP_TYPE_VALUE},
  54            {DPID_SENSE_DELAY, DP_TYPE_VALUE},
  55            {DPID_SENSE_SWITCH, DP_TYPE_BOOL},
  56            {DPID_STAYON_DELAY, DP_TYPE_VALUE},
  57            {DPID_SENSE_STRESS, DP_TYPE_VALUE},
  58            {DPID_SENSE_CIRCLE_R, DP_TYPE_VALUE},
  59          };
  60          
  61          
  62          
  63          
  64          /******************************************************************************
  65                                     2:ä¸²å£å•å­—èŠ‚å‘é€å‡½æ•°
  66          è¯·å°†MCUä¸²å£å‘é€å‡½æ•°å¡«å…¥è¯¥å‡½æ•°å†…,å¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ä¸²å£å‘é€å‡½æ•°
  67          ******************************************************************************/
  68          
  69          /*****************************************************************************
  70          å‡½æ•°åç§° : uart_transmit_output
  71          åŠŸèƒ½æè¿° : å‘æ•°æ®å¤„ç†
  72          è¾“å…¥å‚æ•° : value:ä¸²å£æ”¶åˆ°å­—èŠ‚æ•°æ®
  73          è¿”å›å‚æ•° : æ— 
  74          ä½¿ç”¨è¯´æ˜ : è¯·å°†MCUä¸²å£å‘é€å‡½æ•°å¡«å…¥è¯¥å‡½æ•°å†…,å¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ä¸²
             -å£å‘é€å‡½æ•°
  75          *****************************************************************************/
  76          void uart_transmit_output(unsigned char value)
  77          {
  78   1       //#error "è¯·å°†MCUä¸²å£å‘é€å‡½æ•°å¡«å…¥è¯¥å‡½æ•°,å¹¶åˆ é™¤è¯¥è¡Œ"
  79   1          send_data(value);
  80   1      /*
  81   1        //ç¤ºä¾‹:
  82   1        extern void Uart_PutChar(unsigned char value);
  83   1        Uart_PutChar(value);                                  //ä¸²å£å‘é€å‡½æ•°
  84   1      */  
  85   1      }
  86          /******************************************************************************
  87                                     ç¬¬äºŒæ­¥:å®ç°å…·ä½“ç”¨æˆ·å‡½æ•°
  88          1:APPä¸‹å‘æ•°æ®å¤„ç†
  89          2:æ•°æ®ä¸ŠæŠ¥å¤„ç†
  90          ******************************************************************************/
  91          
  92          /******************************************************************************
  93                                      1:æ‰€æœ‰æ•°æ®ä¸ŠæŠ¥å¤„ç†
  94          å½“å‰å‡½æ•°å¤„ç†å…¨éƒ¨æ•°æ®ä¸ŠæŠ¥(åŒ…æ‹¬å¯ä¸‹å‘/å¯ä¸ŠæŠ¥å’Œåªä¸ŠæŠ¥)
  95            éœ€è¦ç”¨æˆ·æŒ‰ç…§å®é™…æƒ…å†µå®ç°:
  96            1:éœ€è¦å®ç°å¯ä¸‹å‘/å¯ä¸ŠæŠ¥æ•°æ®ç‚¹ä¸ŠæŠ¥
  97            2:éœ€è¦å®ç°åªä¸ŠæŠ¥æ•°æ®ç‚¹ä¸ŠæŠ¥
  98          æ­¤å‡½æ•°ä¸ºMCUå†…éƒ¨å¿…é¡»è°ƒç”¨
  99          ç”¨æˆ·ä¹Ÿå¯è°ƒç”¨æ­¤å‡½æ•°å®ç°å…¨éƒ¨æ•°æ®ä¸ŠæŠ¥
 100          ******************************************************************************/
 101          
 102          //è‡ªåŠ¨åŒ–ç”Ÿæˆæ•°æ®ä¸ŠæŠ¥å‡½æ•°
 103          
 104          /*****************************************************************************
 105          å‡½æ•°åç§° : all_data_update
 106          åŠŸèƒ½æè¿° : ç³»ç»Ÿæ‰€æœ‰dpç‚¹ä¿¡æ¯ä¸Šä¼ ,å®ç°APPå’Œmucæ•°æ®åŒæ­¥
 107          è¾“å…¥å‚æ•° : æ— 
 108          è¿”å›å‚æ•° : æ— 
 109          ä½¿ç”¨è¯´æ˜ : æ­¤å‡½æ•°SDKå†…éƒ¨éœ€è°ƒç”¨;
 110                     MCUå¿…é¡»å®ç°è¯¥å‡½æ•°å†…æ•°æ®ä¸ŠæŠ¥åŠŸèƒ½;åŒ…æ‹¬åªä¸ŠæŠ¥å’Œå¯ä¸ŠæŠ¥å¯ä¸‹å‘å‹æ•°æ®
 111          *****************************************************************************/
 112          void all_data_update(void)
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 3   

 113          {
 114   1        //#error "è¯·åœ¨æ­¤å¤„ç†å¯ä¸‹å‘å¯ä¸ŠæŠ¥æ•°æ®åŠåªä¸ŠæŠ¥æ•°æ®ç¤ºä¾‹,å¤„ç†å®Œæˆååˆ é™¤è¯¥è¡Œ"
 115   1        //æ­¤ä»£ç ä¸ºå¹³å°è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·æŒ‰ç…§å®é™…æ•°æ®ä¿®æ”¹æ¯ä¸ªå¯ä¸‹å‘å¯ä¸ŠæŠ¥å‡½æ•°å’Œåªä¸ŠæŠ¥
             -å‡½æ•°
 116   1      
 117   1          /*
 118   1          mcu_dp_bool_update(DPID_SWITCH_LED,å½“å‰å¼€å…³); //BOOLå‹æ•°æ®ä¸ŠæŠ¥;
 119   1          mcu_dp_value_update(DPID_BRIGHT_VALUE,å½“å‰äº®åº¦å€¼); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 120   1          mcu_dp_value_update(DPID_LIGHT_PARAMETER,å½“å‰å…‰æ•å‚æ•°); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 121   1          mcu_dp_value_update(DPID_SENSE_DELAY,å½“å‰æ„Ÿåº”å»¶æ—¶); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 122   1          mcu_dp_bool_update(DPID_SENSE_SWITCH,å½“å‰æ„Ÿåº”å¼€å…³); //BOOLå‹æ•°æ®ä¸ŠæŠ¥;
 123   1          mcu_dp_value_update(DPID_STAYON_DELAY,å½“å‰ä¼´äº®å»¶æ—¶); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 124   1          mcu_dp_value_update(DPID_SENSE_STRESS,å½“å‰æ„Ÿåº”å¼ºåº¦); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 125   1          mcu_dp_value_update(DPID_SENSE_CIRCLE_R,å½“å‰æ„Ÿåº”åŠå¾„); //VALUEå‹æ•°æ®ä¸ŠæŠ¥;
 126   1          */
 127   1      
 128   1      
 129   1      }
 130          
 131          
 132          /******************************************************************************
 133                                          WARNING!!!    
 134                                      2:æ‰€æœ‰æ•°æ®ä¸ŠæŠ¥å¤„ç†
 135          è‡ªåŠ¨åŒ–ä»£ç æ¨¡æ¿å‡½æ•°,å…·ä½“è¯·ç”¨æˆ·è‡ªè¡Œå®ç°æ•°æ®å¤„ç†
 136          ******************************************************************************/
 137          
 138          /*****************************************************************************
 139          å‡½æ•°åç§° : dp_download_switch_led_handle
 140          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_SWITCH_LEDçš„å¤„ç†å‡½æ•°
 141          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 142                  : length:æ•°æ®é•¿åº¦
 143          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 144          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 145          *****************************************************************************/
 146          static unsigned char dp_download_switch_led_handle(const unsigned char value[], unsigned short length)
 147          {
 148   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºBOOL
 149   1          unsigned char ret;
 150   1          //0:å…³/1:å¼€
 151   1          unsigned char switch_led;
 152   1          
 153   1          switch_led = mcu_get_dp_download_bool(value,length);
 154   1          if(switch_led == 0) {
 155   2              //å¼€å…³å…³
 156   2          }else {
 157   2              //å¼€å…³å¼€
 158   2          }
 159   1        
 160   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 161   1          ret = mcu_dp_bool_update(DPID_SWITCH_LED,switch_led);
 162   1          if(ret == SUCCESS)
 163   1              return SUCCESS;
 164   1          else
 165   1              return ERROR;
 166   1      }
 167          /*****************************************************************************
 168          å‡½æ•°åç§° : dp_download_bright_value_handle
 169          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_BRIGHT_VALUEçš„å¤„ç†å‡½æ•°
 170          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 171                  : length:æ•°æ®é•¿åº¦
 172          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 173          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 4   

 174          *****************************************************************************/
 175          static unsigned char dp_download_bright_value_handle(const unsigned char value[], unsigned short length)
 176          {
 177   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 178   1          unsigned char ret;
 179   1          unsigned long bright_value;
 180   1          
 181   1          bright_value = mcu_get_dp_download_value(value,length);
 182   1          /*
 183   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 184   1          
 185   1          */
 186   1          
 187   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 188   1          ret = mcu_dp_value_update(DPID_BRIGHT_VALUE,bright_value);
 189   1          if(ret == SUCCESS)
 190   1              return SUCCESS;
 191   1          else
 192   1              return ERROR;
 193   1      }
 194          /*****************************************************************************
 195          å‡½æ•°åç§° : dp_download_light_parameter_handle
 196          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_LIGHT_PARAMETERçš„å¤„ç†å‡½æ•°
 197          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 198                  : length:æ•°æ®é•¿åº¦
 199          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 200          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 201          *****************************************************************************/
 202          static unsigned char dp_download_light_parameter_handle(const unsigned char value[], unsigned short length
             -)
 203          {
 204   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 205   1          unsigned char ret;
 206   1          unsigned long light_parameter;
 207   1          
 208   1          light_parameter = mcu_get_dp_download_value(value,length);
 209   1          /*
 210   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 211   1          
 212   1          */
 213   1          
 214   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 215   1          ret = mcu_dp_value_update(DPID_LIGHT_PARAMETER,light_parameter);
 216   1          if(ret == SUCCESS)
 217   1              return SUCCESS;
 218   1          else
 219   1              return ERROR;
 220   1      }
 221          /*****************************************************************************
 222          å‡½æ•°åç§° : dp_download_sense_delay_handle
 223          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_SENSE_DELAYçš„å¤„ç†å‡½æ•°
 224          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 225                  : length:æ•°æ®é•¿åº¦
 226          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 227          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 228          *****************************************************************************/
 229          static unsigned char dp_download_sense_delay_handle(const unsigned char value[], unsigned short length)
 230          {
 231   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 232   1          unsigned char ret;
 233   1          unsigned long sense_delay;
 234   1          
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 5   

 235   1          sense_delay = mcu_get_dp_download_value(value,length);
 236   1          /*
 237   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 238   1          
 239   1          */
 240   1          
 241   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 242   1          ret = mcu_dp_value_update(DPID_SENSE_DELAY,sense_delay);
 243   1          if(ret == SUCCESS)
 244   1              return SUCCESS;
 245   1          else
 246   1              return ERROR;
 247   1      }
 248          /*****************************************************************************
 249          å‡½æ•°åç§° : dp_download_sense_switch_handle
 250          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_SENSE_SWITCHçš„å¤„ç†å‡½æ•°
 251          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 252                  : length:æ•°æ®é•¿åº¦
 253          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 254          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 255          *****************************************************************************/
 256          static unsigned char dp_download_sense_switch_handle(const unsigned char value[], unsigned short length)
 257          {
 258   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºBOOL
 259   1          unsigned char ret;
 260   1          //0:å…³/1:å¼€
 261   1          unsigned char sense_switch;
 262   1          
 263   1          sense_switch = mcu_get_dp_download_bool(value,length);
 264   1          if(sense_switch == 0) {
 265   2              //å¼€å…³å…³
 266   2          }else {
 267   2              //å¼€å…³å¼€
 268   2          }
 269   1        
 270   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 271   1          ret = mcu_dp_bool_update(DPID_SENSE_SWITCH,sense_switch);
 272   1          if(ret == SUCCESS)
 273   1              return SUCCESS;
 274   1          else
 275   1              return ERROR;
 276   1      }
 277          /*****************************************************************************
 278          å‡½æ•°åç§° : dp_download_stayon_delay_handle
 279          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_STAYON_DELAYçš„å¤„ç†å‡½æ•°
 280          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 281                  : length:æ•°æ®é•¿åº¦
 282          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 283          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 284          *****************************************************************************/
 285          static unsigned char dp_download_stayon_delay_handle(const unsigned char value[], unsigned short length)
 286          {
 287   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 288   1          unsigned char ret;
 289   1          unsigned long stayon_delay;
 290   1          
 291   1          stayon_delay = mcu_get_dp_download_value(value,length);
 292   1          /*
 293   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 294   1          
 295   1          */
 296   1          
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 6   

 297   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 298   1          ret = mcu_dp_value_update(DPID_STAYON_DELAY,stayon_delay);
 299   1          if(ret == SUCCESS)
 300   1              return SUCCESS;
 301   1          else
 302   1              return ERROR;
 303   1      }
 304          /*****************************************************************************
 305          å‡½æ•°åç§° : dp_download_sense_stress_handle
 306          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_SENSE_STRESSçš„å¤„ç†å‡½æ•°
 307          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 308                  : length:æ•°æ®é•¿åº¦
 309          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 310          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 311          *****************************************************************************/
 312          static unsigned char dp_download_sense_stress_handle(const unsigned char value[], unsigned short length)
 313          {
 314   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 315   1          unsigned char ret;
 316   1          unsigned long sense_stress;
 317   1          
 318   1          sense_stress = mcu_get_dp_download_value(value,length);
 319   1          /*
 320   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 321   1          
 322   1          */
 323   1          
 324   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 325   1          ret = mcu_dp_value_update(DPID_SENSE_STRESS,sense_stress);
 326   1          if(ret == SUCCESS)
 327   1              return SUCCESS;
 328   1          else
 329   1              return ERROR;
 330   1      }
 331          /*****************************************************************************
 332          å‡½æ•°åç§° : dp_download_sense_circle_r_handle
 333          åŠŸèƒ½æè¿° : é’ˆå¯¹DPID_SENSE_CIRCLE_Rçš„å¤„ç†å‡½æ•°
 334          è¾“å…¥å‚æ•° : value:æ•°æ®æºæ•°æ®
 335                  : length:æ•°æ®é•¿åº¦
 336          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERROR
 337          ä½¿ç”¨è¯´æ˜ : å¯ä¸‹å‘å¯ä¸ŠæŠ¥ç±»å‹,éœ€è¦åœ¨å¤„ç†å®Œæ•°æ®åä¸ŠæŠ¥å¤„ç†ç»“æœè‡³app
 338          *****************************************************************************/
 339          static unsigned char dp_download_sense_circle_r_handle(const unsigned char value[], unsigned short length)
 340          {
 341   1          //ç¤ºä¾‹:å½“å‰DPç±»å‹ä¸ºVALUE
 342   1          unsigned char ret;
 343   1          unsigned long sense_circle_r;
 344   1          
 345   1          sense_circle_r = mcu_get_dp_download_value(value,length);
 346   1          /*
 347   1          //VALUEç±»å‹æ•°æ®å¤„ç†
 348   1          
 349   1          */
 350   1          
 351   1          //å¤„ç†å®ŒDPæ•°æ®ååº”æœ‰åé¦ˆ
 352   1          ret = mcu_dp_value_update(DPID_SENSE_CIRCLE_R,sense_circle_r);
 353   1          if(ret == SUCCESS)
 354   1              return SUCCESS;
 355   1          else
 356   1              return ERROR;
 357   1      }
 358          
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 7   

 359          
 360          /******************************************************************************
 361                                          WARNING!!!                     
 362          æ­¤ä»£ç ä¸ºSDKå†…éƒ¨è°ƒç”¨,è¯·æŒ‰ç…§å®é™…dpæ•°æ®å®ç°å‡½æ•°å†…éƒ¨æ•°æ®
 363          ******************************************************************************/
 364          #ifdef SUPPORT_MCU_FIRM_UPDATE
              /*****************************************************************************
              å‡½æ•°åç§° : mcu_firm_update_handle
              åŠŸèƒ½æè¿° : MCUè¿›å…¥å›ºä»¶å‡çº§æ¨¡å¼
              è¾“å…¥å‚æ•° : value:å›ºä»¶ç¼“å†²åŒº
                         position:å½“å‰æ•°æ®åŒ…åœ¨äºå›ºä»¶ä½ç½®
                         length:å½“å‰å›ºä»¶åŒ…é•¿åº¦(å›ºä»¶åŒ…é•¿åº¦ä¸º0æ—¶,è¡¨ç¤ºå›ºä»¶åŒ…å‘é€å®Œæˆ)
              è¿”å›å‚æ•° : æ— 
              ä½¿ç”¨è¯´æ˜ : MCUéœ€è¦è‡ªè¡Œå®ç°è¯¥åŠŸèƒ½
              *****************************************************************************/
              unsigned char mcu_firm_update_handle(const unsigned char value[],unsigned long position,unsigned short len
             -gth)
              {
                #error "è¯·è‡ªè¡Œå®ŒæˆMCUå›ºä»¶å‡çº§ä»£ç ,å®Œæˆåè¯·åˆ é™¤è¯¥è¡Œ"
                unsigned long addr;
               
                if(length == 0)
                {
              #ifdef ENABLE_BOOT
                  //å›ºä»¶æ•°æ®å‘é€å®Œæˆ
                  FlashBuffer.magic_code = FIREWARE_UPDATE_FLAG;
                  
                  if(Earse_Flash(PARA_ADDR) == ERROR)
                    return ERROR;
                  
                  //å†™å…¥å‡çº§æ ‡å¿—
                  if(Write_Flash(PARA_ADDR,(unsigned char *)&FlashBuffer,sizeof(FlashBuffer)) == ERROR)
                    return ERROR;
                  
                  Reset();
              #endif
                }
                else
                {
                  //å›ºä»¶æ•°æ®å¤„ç†
                  addr = FIREWARE_ADDR_H;
                   
                  if(position % 1024 == 0)
                  {
                    if(Earse_Flash(addr + position) == ERROR)
                      return ERROR;
                  }
                  
                  if(Write_Flash(addr + position,(unsigned char *)value,length) == ERROR)
                    return ERROR;
                }
              
                return SUCCESS;
              }
              #endif
 413          /******************************************************************************
 414                                          WARNING!!!                     
 415          ä»¥ä¸‹å‡½æ•°ç”¨æˆ·è¯·å‹¿ä¿®æ”¹!!
 416          ******************************************************************************/
 417          
 418          /*****************************************************************************
 419          å‡½æ•°åç§° : dp_download_handle
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 8   

 420          åŠŸèƒ½æè¿° : dpä¸‹å‘å¤„ç†å‡½æ•°
 421          è¾“å…¥å‚æ•° : dpid:DPåºå·
 422                     value:dpæ•°æ®ç¼“å†²åŒºåœ°å€
 423                     length:dpæ•°æ®é•¿åº¦
 424          è¿”å›å‚æ•° : æˆåŠŸè¿”å›:SUCCESS/å¤±è´¥è¿”å›:ERRO
 425          ä½¿ç”¨è¯´æ˜ : è¯¥å‡½æ•°ç”¨æˆ·ä¸èƒ½ä¿®æ”¹
 426          *****************************************************************************/
 427          unsigned char dp_download_handle(unsigned char dpid,const unsigned char value[], unsigned short length)
 428          {
 429   1        /*********************************
 430   1        å½“å‰å‡½æ•°å¤„ç†å¯ä¸‹å‘/å¯ä¸ŠæŠ¥æ•°æ®è°ƒç”¨                    
 431   1        å…·ä½“å‡½æ•°å†…éœ€è¦å®ç°ä¸‹å‘æ•°æ®å¤„ç†
 432   1        å®Œæˆç”¨éœ€è¦å°†å¤„ç†ç»“æœåé¦ˆè‡³APPç«¯,å¦åˆ™APPä¼šè®¤ä¸ºä¸‹å‘å¤±è´¥
 433   1        ***********************************/
 434   1        unsigned char ret;
 435   1        switch(dpid)
 436   1        {
 437   2              case DPID_SWITCH_LED:
 438   2                  //å¼€å…³å¤„ç†å‡½æ•°
 439   2                  ret = dp_download_switch_led_handle(value,length);
 440   2              break;
 441   2              case DPID_BRIGHT_VALUE:
 442   2                  //äº®åº¦å€¼å¤„ç†å‡½æ•°
 443   2                  ret = dp_download_bright_value_handle(value,length);
 444   2              break;
 445   2              case DPID_LIGHT_PARAMETER:
 446   2                  //å…‰æ•å‚æ•°å¤„ç†å‡½æ•°
 447   2                  ret = dp_download_light_parameter_handle(value,length);
 448   2              break;
 449   2              case DPID_SENSE_DELAY:
 450   2                  //æ„Ÿåº”å»¶æ—¶å¤„ç†å‡½æ•°
 451   2                  ret = dp_download_sense_delay_handle(value,length);
 452   2              break;
 453   2              case DPID_SENSE_SWITCH:
 454   2                  //æ„Ÿåº”å¼€å…³å¤„ç†å‡½æ•°
 455   2                  ret = dp_download_sense_switch_handle(value,length);
 456   2              break;
 457   2              case DPID_STAYON_DELAY:
 458   2                  //ä¼´äº®å»¶æ—¶å¤„ç†å‡½æ•°
 459   2                  ret = dp_download_stayon_delay_handle(value,length);
 460   2              break;
 461   2              case DPID_SENSE_STRESS:
 462   2                  //æ„Ÿåº”å¼ºåº¦å¤„ç†å‡½æ•°
 463   2                  ret = dp_download_sense_stress_handle(value,length);
 464   2              break;
 465   2              case DPID_SENSE_CIRCLE_R:
 466   2                  //æ„Ÿåº”åŠå¾„å¤„ç†å‡½æ•°
 467   2                  ret = dp_download_sense_circle_r_handle(value,length);
 468   2              break;
 469   2      
 470   2      
 471   2        default:
 472   2          break;
 473   2        }
 474   1        return ret;
 475   1      }
 476          /*****************************************************************************
 477          å‡½æ•°åç§° : get_download_cmd_total
 478          åŠŸèƒ½æè¿° : è·å–æ‰€æœ‰dpå‘½ä»¤æ€»å’Œ
 479          è¾“å…¥å‚æ•° : æ— 
 480          è¿”å›å‚æ•° : ä¸‹å‘å‘½ä»¤æ€»å’Œ
 481          ä½¿ç”¨è¯´æ˜ : è¯¥å‡½æ•°ç”¨æˆ·ä¸èƒ½ä¿®æ”¹
C51 COMPILER V8.02   PROTOCOL                                                              10/06/2020 17:42:47 PAGE 9   

 482          *****************************************************************************/
 483          unsigned char get_download_cmd_total(void)
 484          {
 485   1        return(sizeof(download_cmd) / sizeof(download_cmd[0]));
 486   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    529    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     16      31
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
